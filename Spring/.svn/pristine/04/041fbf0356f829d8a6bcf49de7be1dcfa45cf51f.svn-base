<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sportsfactory.sportforall.dao.HomeDao">
	<select id="getAlarmList" parameterType="HomeAlarmDto" resultType="HomeAlarmDto">
		SELECT A.* FROM (
			(SELECT A.*, C.CLUB_NAME, S.CATEGORY_CODE, S.NAME, U.USER_NAME,
				DATE_FORMAT(A.WRITE_DATE,"%Y. %m. %d.") AS FORMATTED_WRITE_DATE,
				IF(DATE_FORMAT(A.WRITE_TIME,"%p")="AM",
				DATE_FORMAT(A.WRITE_TIME,"오전 %h시 %i분"),
				DATE_FORMAT(A.WRITE_TIME,"오후 %h시 %i분")) AS FORMATTED_WRITE_TIME
			FROM USER_ALARM A, CLUB_INFO C, SPORTS_TYPE_INFO S, USER_INFO U
			WHERE A.USER_ID = #{USER_ID} AND A.CLUB_CODE = C.CLUB_CODE
				AND C.SPORTS_TYPE_CODE = S.CATEGORY_CODE AND A.WRITE_USER = U.USER_ID
				AND ((A.BOARD_TYPE = 3 AND (A.SUB_TYPE = 1 OR (A.SUB_TYPE = 2 AND A.WRITE_DATE &lt; NOW()-INTERVAL 7 DAY)))
				OR A.BOARD_TYPE NOT IN (3,6)))
			UNION DISTINCT
			(SELECT A.*, F.FED_NAME AS CLUB_NAME, S.CATEGORY_CODE, S.NAME, U.USER_NAME,
				DATE_FORMAT(A.WRITE_DATE,"%Y. %m. %d.") AS FORMATTED_WRITE_DATE,
				IF(DATE_FORMAT(A.WRITE_TIME,"%p")="AM",
				DATE_FORMAT(A.WRITE_TIME,"오전 %h시 %i분"),
				DATE_FORMAT(A.WRITE_TIME,"오후 %h시 %i분")) AS FORMATTED_WRITE_TIME
			FROM USER_ALARM A, FEDERATION_INFO F, SPORTS_TYPE_INFO S, USER_INFO U
			WHERE A.USER_ID = #{USER_ID} AND A.CLUB_CODE = F.FED_CODE
				AND F.SPORTS_TYPE_CODE = S.CATEGORY_CODE AND A.WRITE_USER = U.USER_ID
				AND (A.BOARD_TYPE = 6 AND (A.SUB_TYPE = 1 OR (A.SUB_TYPE = 2 AND A.WRITE_DATE &lt; NOW()-INTERVAL 7 DAY))))
			) A
		ORDER BY A.ALARM_ID DESC
		LIMIT #{PAGE}, 20
	</select>
	<select id="getResponseAlarmListWeek" parameterType="HomeAlarmDto" resultType="HomeAlarmDto">
		SELECT A.* FROM (
			(SELECT A.*, C.CLUB_NAME, S.CATEGORY_CODE, S.NAME, U.USER_NAME,
				DATE_FORMAT(A.WRITE_DATE,"%Y. %m. %d.") AS FORMATTED_WRITE_DATE,
				IF(DATE_FORMAT(A.WRITE_TIME,"%p")="AM",
				DATE_FORMAT(A.WRITE_TIME,"오전 %h시 %i분"),
				DATE_FORMAT(A.WRITE_TIME,"오후 %h시 %i분")) AS FORMATTED_WRITE_TIME
			FROM USER_ALARM A, CLUB_INFO C, SPORTS_TYPE_INFO S, USER_INFO U
			WHERE A.USER_ID = #{USER_ID} AND A.CLUB_CODE = C.CLUB_CODE
				AND C.SPORTS_TYPE_CODE = S.CATEGORY_CODE AND A.WRITE_USER = U.USER_ID
				AND (A.BOARD_TYPE = 3 AND A.SUB_TYPE = 2) AND A.WRITE_DATE &gt;= NOW() - INTERVAL 7 DAY)
			UNION DISTINCT
			(SELECT A.*, F.FED_NAME AS CLUB_NAME, S.CATEGORY_CODE, S.NAME, U.USER_NAME,
				DATE_FORMAT(A.WRITE_DATE,"%Y. %m. %d.") AS FORMATTED_WRITE_DATE,
				IF(DATE_FORMAT(A.WRITE_TIME,"%p")="AM",
				DATE_FORMAT(A.WRITE_TIME,"오전 %h시 %i분"),
				DATE_FORMAT(A.WRITE_TIME,"오후 %h시 %i분")) AS FORMATTED_WRITE_TIME
			FROM USER_ALARM A, FEDERATION_INFO F, SPORTS_TYPE_INFO S, USER_INFO U
			WHERE A.USER_ID = #{USER_ID} AND A.CLUB_CODE = F.FED_CODE
				AND F.SPORTS_TYPE_CODE = S.CATEGORY_CODE AND A.WRITE_USER = U.USER_ID
				AND (A.BOARD_TYPE = 6 AND A.SUB_TYPE = 2) AND A.WRITE_DATE &gt;= NOW() - INTERVAL 7 DAY)) A
		ORDER BY A.ALARM_ID DESC
	</select>
	<insert id="makeAlarm" parameterType="HomeAlarmDto">
		INSERT INTO USER_ALARM(ALARM_ID, BOARD_TYPE, BOARD_ID, SUB_TYPE, USER_ID, WRITE_USER, WRITE_DATE, WRITE_TIME, CLUB_CODE, IS_READ)
			(SELECT NULL, #{BOARD_TYPE}, #{BOARD_ID}, #{SUB_TYPE}, U.USER_ID, #{WRITE_USER},
				NOW(), NOW(), #{CLUB_CODE}, 0
			FROM USER_INFO U, CLUB_USER C
			WHERE C.CLUB_CODE = #{CLUB_CODE} AND C.USER_ID = U.USER_ID
				AND C.USER_LEVEL >= #{USER_LEVEL} AND U.IS_DELETED = 0
				AND U.USER_ID &lt;&gt; #{WRITE_USER})
	</insert>
	<update id="readAlarm" parameterType="HomeAlarmDto">
		UPDATE USER_ALARM SET IS_READ = 1 WHERE ALARM_ID = #{ALARM_ID} AND USER_ID = #{USER_ID}
	</update>
	<insert id="makeAlarmForOne" parameterType="HomeAlarmDto">
		INSERT INTO USER_ALARM(ALARM_ID, BOARD_TYPE, BOARD_ID, SUB_TYPE, USER_ID, WRITE_USER, WRITE_DATE, WRITE_TIME, CLUB_CODE, IS_READ)
		VALUES(NULL, #{BOARD_TYPE}, #{BOARD_ID}, #{SUB_TYPE}, #{USER_ID}, #{WRITE_USER}, NOW(), NOW(), #{CLUB_CODE}, 0)
	</insert>
	<select id="getAlarmCount" parameterType="AccountDto" resultType="HomeAlarmDto">
		SELECT COUNT(*) AS ALARM_COUNT FROM USER_ALARM A, CLUB_INFO C, USER_INFO U
		WHERE A.USER_ID = #{USER_ID} AND A.IS_READ = 0 AND A.CLUB_CODE = C.CLUB_CODE AND A.WRITE_USER = U.USER_ID
		AND C.IS_DELETED = 0 AND U.IS_DELETED = 0
	</select>
	<insert id="makeFedAlarm" parameterType="HomeAlarmDto">
		INSERT INTO USER_ALARM(ALARM_ID, BOARD_TYPE, BOARD_ID, SUB_TYPE, USER_ID, WRITE_USER, WRITE_DATE, WRITE_TIME, CLUB_CODE, IS_READ)
			(SELECT NULL, #{BOARD_TYPE}, #{BOARD_ID}, #{SUB_TYPE}, U.USER_ID, #{WRITE_USER},
				NOW(), NOW(), #{CLUB_CODE}, 0
			FROM USER_INFO U, FED_MANAGER F
			WHERE F.FED_CODE = #{CLUB_CODE} AND F.USER_ID = U.USER_ID
				AND F.USER_LEVEL >= #{USER_LEVEL} AND U.IS_DELETED = 0
				AND U.USER_ID &lt;&gt; #{WRITE_USER})
	</insert>
	<insert id="makeFedAlarmForOne" parameterType="HomeAlarmDto">
		INSERT INTO USER_ALARM(ALARM_ID, BOARD_TYPE, BOARD_ID, SUB_TYPE, USER_ID, WRITE_USER, WRITE_DATE, WRITE_TIME, CLUB_CODE, IS_READ)
		VALUES(NULL, #{BOARD_TYPE}, #{BOARD_ID}, #{SUB_TYPE}, #{USER_ID}, #{WRITE_USER}, NOW(), NOW(), #{CLUB_CODE}, 0)
	</insert>
	<update id="updateSubType" parameterType="HomeAlarmDto">
		UPDATE USER_ALARM SET SUB_TYPE = #{SUB_TYPE} WHERE ALARM_ID = #{ALARM_ID}
	</update>
</mapper>